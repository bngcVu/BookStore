// BookStore Database - DBML for dbdiagram.io
// Copy nội dung này vào https://dbdiagram.io/d

// ============================================================
// 1. USER MANAGEMENT
// ============================================================

Table customer_tiers {
  id bigint [pk, increment]
  name varchar(50) [unique, not null, note: 'Tên cấp bậc: Bạc, Vàng, Kim cương']
  min_spent decimal(15,2) [not null, default: 0, note: 'Tổng chi tiêu tối thiểu']
  discount_percent tinyint [not null, default: 0]
  benefits text
  created_at datetime [not null, default: `now()`]
}

Table users {
  id bigint [pk, increment]
  email varchar(255) [unique, note: 'Email đăng nhập']
  phone varchar(20) [unique, note: 'Số điện thoại']
  password_hash varchar(255) [not null]
  full_name varchar(100) [not null]
  avatar_url varchar(500)
  date_of_birth date
  gender enum('male','female','other')
  default_address text
  tier_id bigint [ref: > customer_tiers.id, note: 'Cấp bậc VIP']
  total_spent decimal(15,2) [not null, default: 0]
  reward_points int [not null, default: 0]
  status enum('active','inactive','banned') [not null, default: 'active']
  email_verified_at datetime
  phone_verified_at datetime
  last_login_at datetime
  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]
}

Table admins {
  id bigint [pk, increment]
  email varchar(255) [unique, not null]
  password_hash varchar(255) [not null]
  full_name varchar(100) [not null]
  avatar_url varchar(500)
  role enum('super_admin','admin','staff') [not null, default: 'staff']
  permissions json [note: 'Quyền hạn chi tiết']
  is_active tinyint [not null, default: 1]
  last_login_at datetime
  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]
}

Table otp_codes {
  id bigint [pk, increment]
  user_id bigint [ref: > users.id]
  email varchar(255)
  phone varchar(20)
  code varchar(10) [not null, note: 'Mã OTP']
  type enum('register','reset_password','verify_email','verify_phone') [not null]
  expires_at datetime [not null]
  is_used tinyint [not null, default: 0]
  created_at datetime [not null, default: `now()`]
}

// ============================================================
// 2. PRODUCT CATALOG
// ============================================================

Table categories {
  id bigint [pk, increment]
  name varchar(100) [not null, note: 'Tên danh mục']
  slug varchar(120) [unique, not null]
  parent_id bigint [ref: > categories.id, note: 'Danh mục cha']
  level tinyint [not null, default: 0, note: '0=gốc, 1=con, 2=cháu']
  description text
  image_url varchar(500)
  sort_order int [not null, default: 0]
  is_active tinyint [not null, default: 1]
  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]
}

Table authors {
  id bigint [pk, increment]
  name varchar(150) [not null, note: 'Tên tác giả']
  slug varchar(170) [unique, not null]
  biography text
  image_url varchar(500)
  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]
}

Table publishers {
  id bigint [pk, increment]
  name varchar(150) [unique, not null, note: 'Tên NXB']
  slug varchar(170) [unique, not null]
  address text
  phone varchar(20)
  email varchar(255)
  website varchar(255)
  logo_url varchar(500)
  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]
}

Table books {
  id bigint [pk, increment]
  category_id bigint [not null, ref: > categories.id]
  publisher_id bigint [not null, ref: > publishers.id]
  title varchar(300) [not null, note: 'Tên sách']
  slug varchar(350) [unique, not null]
  isbn varchar(20) [unique, note: 'Mã ISBN']
  publication_year smallint
  pages smallint
  dimensions varchar(50) [note: 'Kích thước: 20x14x2 cm']
  weight_grams int [note: 'Trọng lượng (gram)']
  cover_type enum('soft','hard') [default: 'soft']
  language varchar(50) [default: 'Tiếng Việt']
  description text [note: 'Mô tả chi tiết - FULLTEXT']
  base_price decimal(12,2) [not null]
  avg_rating decimal(2,1) [not null, default: 0]
  review_count int [not null, default: 0]
  sold_count int [not null, default: 0]
  view_count int [not null, default: 0]
  is_active tinyint [not null, default: 1]
  is_featured tinyint [not null, default: 0]
  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]
}

Table book_authors {
  id bigint [pk, increment]
  book_id bigint [not null, ref: > books.id]
  author_id bigint [not null, ref: > authors.id]
  is_primary tinyint [not null, default: 0, note: 'Tác giả chính']
  
  indexes {
    (book_id, author_id) [unique]
  }
}

Table book_variants {
  id bigint [pk, increment]
  book_id bigint [not null, ref: > books.id]
  publisher_id bigint [not null, ref: > publishers.id]
  sku varchar(50) [unique, not null, note: 'Mã SKU']
  cover_type enum('soft','hard') [not null, default: 'soft']
  edition varchar(100) [note: 'Phiên bản: Tái bản lần 5']
  price decimal(12,2) [not null]
  compare_at_price decimal(12,2) [note: 'Giá gốc (gạch)']
  is_active tinyint [not null, default: 1]
  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]
}

Table book_images {
  id bigint [pk, increment]
  book_id bigint [not null, ref: > books.id]
  image_url varchar(500) [not null]
  alt_text varchar(255)
  is_primary tinyint [not null, default: 0]
  sort_order tinyint [not null, default: 0]
  created_at datetime [not null, default: `now()`]
}

Table price_history {
  id bigint [pk, increment]
  variant_id bigint [not null, ref: > book_variants.id]
  old_price decimal(12,2) [not null]
  new_price decimal(12,2) [not null]
  changed_by bigint [ref: > admins.id]
  reason varchar(255)
  created_at datetime [not null, default: `now()`]
}

// ============================================================
// 3. INVENTORY
// ============================================================

Table inventory {
  id bigint [pk, increment]
  variant_id bigint [unique, not null, ref: > book_variants.id]
  quantity int [not null, default: 0, note: 'Số lượng tồn kho']
  reserved_quantity int [not null, default: 0, note: 'Đã đặt']
  min_stock_level int [not null, default: 5]
  last_restocked_at datetime
  updated_at datetime [not null, default: `now()`]
}

Table inventory_history {
  id bigint [pk, increment]
  variant_id bigint [not null, ref: > book_variants.id]
  type enum('in','out','adjust','reserve','release') [not null, note: 'Nhập/Xuất/Điều chỉnh']
  quantity_change int [not null, note: 'Số lượng +/-']
  quantity_after int [not null]
  reason varchar(255)
  reference_type varchar(50)
  reference_id bigint
  created_by bigint [ref: > admins.id]
  created_at datetime [not null, default: `now()`]
}

// ============================================================
// 4. SHIPPING
// ============================================================

Table shipping_carriers {
  id bigint [pk, increment]
  name varchar(100) [unique, not null, note: 'GHTK, GHN, Viettel Post, J&T']
  code varchar(20) [unique, not null]
  logo_url varchar(500)
  api_endpoint varchar(500)
  api_key varchar(255)
  is_active tinyint [not null, default: 1]
  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]
}

Table shipping_rates {
  id bigint [pk, increment]
  carrier_id bigint [not null, ref: > shipping_carriers.id]
  province_code varchar(10) [not null]
  province_name varchar(100) [not null]
  base_fee decimal(10,2) [not null]
  per_kg_fee decimal(10,2) [not null, default: 0]
  per_500g_fee decimal(10,2) [not null, default: 0]
  free_ship_threshold decimal(12,2)
  estimated_days_min tinyint [not null, default: 1]
  estimated_days_max tinyint [not null, default: 3]
  is_active tinyint [not null, default: 1]
  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]
  
  indexes {
    (carrier_id, province_code) [unique]
  }
}

// ============================================================
// 5. CART & WISHLIST
// ============================================================

Table carts {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  variant_id bigint [not null, ref: > book_variants.id]
  quantity int [not null, default: 1]
  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]
  
  indexes {
    (user_id, variant_id) [unique]
  }
}

Table wishlists {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  book_id bigint [not null, ref: > books.id]
  created_at datetime [not null, default: `now()`]
  
  indexes {
    (user_id, book_id) [unique]
  }
}

// ============================================================
// 6. PROMOTIONS
// ============================================================

Table flash_sales {
  id bigint [pk, increment]
  name varchar(150) [not null]
  description text
  start_time datetime [not null]
  end_time datetime [not null]
  is_active tinyint [not null, default: 1]
  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]
}

Table flash_sale_items {
  id bigint [pk, increment]
  flash_sale_id bigint [not null, ref: > flash_sales.id]
  variant_id bigint [not null, ref: > book_variants.id]
  sale_price decimal(12,2) [not null]
  quantity_limit int [not null, default: 0]
  per_user_limit int [not null, default: 1]
  sold_count int [not null, default: 0]
  created_at datetime [not null, default: `now()`]
  
  indexes {
    (flash_sale_id, variant_id) [unique]
  }
}

Table vouchers {
  id bigint [pk, increment]
  code varchar(50) [unique, not null]
  name varchar(150) [not null]
  description text
  discount_type enum('percent','fixed') [not null]
  discount_value decimal(12,2) [not null]
  max_discount decimal(12,2)
  min_order_value decimal(12,2) [not null, default: 0]
  usage_limit int
  used_count int [not null, default: 0]
  per_user_limit int [not null, default: 1]
  start_date datetime [not null]
  end_date datetime [not null]
  is_active tinyint [not null, default: 1]
  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]
}

Table voucher_usage {
  id bigint [pk, increment]
  voucher_id bigint [not null, ref: > vouchers.id]
  user_id bigint [not null, ref: > users.id]
  order_id bigint
  discount_amount decimal(12,2) [not null]
  used_at datetime [not null, default: `now()`]
}

Table promotions {
  id bigint [pk, increment]
  name varchar(150) [not null]
  description text
  type enum('percent','buy_x_get_y','combo','bundle_discount') [not null]
  discount_percent tinyint [note: 'Giảm %']
  buy_quantity int [note: 'Mua X']
  get_quantity int [note: 'Tặng Y']
  bundle_min_quantity int
  bundle_discount_percent tinyint
  combo_price decimal(12,2)
  start_date datetime [not null]
  end_date datetime [not null]
  is_active tinyint [not null, default: 1]
  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]
}

Table promotion_books {
  id bigint [pk, increment]
  promotion_id bigint [not null, ref: > promotions.id]
  book_id bigint [not null, ref: > books.id]
  is_gift tinyint [not null, default: 0]
  sort_order int [not null, default: 0]
  created_at datetime [not null, default: `now()`]
  
  indexes {
    (promotion_id, book_id) [unique]
  }
}

// ============================================================
// 7. ORDERS
// ============================================================

Table orders {
  id bigint [pk, increment]
  order_code varchar(30) [unique, not null]
  user_id bigint [not null, ref: > users.id]
  voucher_id bigint [ref: > vouchers.id]
  carrier_id bigint [ref: > shipping_carriers.id]
  subtotal decimal(15,2) [not null]
  shipping_fee decimal(10,2) [not null, default: 0]
  discount_amount decimal(12,2) [not null, default: 0]
  points_used int [not null, default: 0]
  points_discount decimal(10,2) [not null, default: 0]
  total_amount decimal(15,2) [not null]
  payment_method enum('cod','bank_transfer','momo','zalopay','vnpay','credit_card','installment') [not null]
  payment_status enum('pending','paid','failed','refunded') [not null, default: 'pending']
  status enum('pending','confirmed','processing','shipping','delivered','completed','cancelled','returned') [not null, default: 'pending']
  shipping_address text [not null]
  recipient_name varchar(100) [not null]
  recipient_phone varchar(20) [not null]
  tracking_number varchar(100)
  note text
  shipped_at datetime
  delivered_at datetime
  completed_at datetime
  cancelled_at datetime
  cancel_reason text
  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]
}

Table order_items {
  id bigint [pk, increment]
  order_id bigint [not null, ref: > orders.id]
  variant_id bigint [not null, ref: > book_variants.id]
  promotion_id bigint [ref: > promotions.id]
  quantity int [not null]
  unit_price decimal(12,2) [not null]
  discount_amount decimal(12,2) [not null, default: 0]
  subtotal decimal(12,2) [not null]
  is_gift tinyint [not null, default: 0]
  is_reviewed tinyint [not null, default: 0]
  created_at datetime [not null, default: `now()`]
}

Table order_status_history {
  id bigint [pk, increment]
  order_id bigint [not null, ref: > orders.id]
  old_status enum('pending','confirmed','processing','shipping','delivered','completed','cancelled','returned')
  new_status enum('pending','confirmed','processing','shipping','delivered','completed','cancelled','returned') [not null]
  note text
  changed_by bigint [ref: > admins.id]
  created_at datetime [not null, default: `now()`]
}

Table refunds {
  id bigint [pk, increment]
  order_id bigint [not null, ref: > orders.id]
  order_item_id bigint [ref: > order_items.id]
  type enum('refund','return','exchange') [not null]
  reason enum('wrong_item','damaged','not_as_described','change_mind','other') [not null]
  description text
  images json
  refund_amount decimal(12,2) [not null, default: 0]
  status enum('pending','approved','rejected','processing','completed') [not null, default: 'pending']
  admin_note text
  processed_by bigint [ref: > admins.id]
  created_at datetime [not null, default: `now()`]
  processed_at datetime
  completed_at datetime
}

// ============================================================
// 8. PAYMENTS
// ============================================================

Table payments {
  id bigint [pk, increment]
  order_id bigint [not null, ref: > orders.id]
  method enum('cod','bank_transfer','momo','zalopay','vnpay','credit_card','installment') [not null]
  transaction_id varchar(100) [unique]
  amount decimal(15,2) [not null]
  status enum('pending','processing','success','failed','cancelled','refunded') [not null, default: 'pending']
  gateway_response json
  installment_months tinyint [note: 'Số tháng trả góp']
  installment_bank varchar(100)
  paid_at datetime
  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]
}

// ============================================================
// 9. REWARDS
// ============================================================

Table reward_points {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  points int [not null]
  type enum('earn','redeem','expire','adjust') [not null]
  reference_type varchar(50)
  reference_id bigint
  description text
  expires_at datetime
  created_at datetime [not null, default: `now()`]
}

Table loyalty_transactions {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  transaction_type enum('earn','spend','expire','bonus','refund') [not null]
  points_amount int [not null]
  points_balance_after int [not null]
  reference_type varchar(50)
  reference_id bigint
  description text
  created_at datetime [not null, default: `now()`]
}

// ============================================================
// 10. REVIEWS
// ============================================================

Table reviews {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  book_id bigint [not null, ref: > books.id]
  order_item_id bigint [unique, not null, ref: > order_items.id, note: 'Chỉ đánh giá khi đã mua']
  rating tinyint [not null, note: '1-5 sao']
  title varchar(200)
  comment text
  pros text [note: 'Ưu điểm']
  cons text [note: 'Nhược điểm']
  is_verified tinyint [not null, default: 1]
  is_visible tinyint [not null, default: 1]
  helpful_count int [not null, default: 0]
  created_at datetime [not null, default: `now()`]
  updated_at datetime [not null, default: `now()`]
}

Table review_images {
  id bigint [pk, increment]
  review_id bigint [not null, ref: > reviews.id]
  image_url varchar(500) [not null]
  sort_order tinyint [not null, default: 0]
  created_at datetime [not null, default: `now()`]
}

// ============================================================
// 11. NOTIFICATIONS
// ============================================================

Table notifications {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  title varchar(200) [not null]
  content text [not null]
  type enum('order','promotion','system','review','reward') [not null]
  reference_type varchar(50)
  reference_id bigint
  is_read tinyint [not null, default: 0]
  is_email_sent tinyint [not null, default: 0]
  read_at datetime
  created_at datetime [not null, default: `now()`]
}

// ============================================================
// 12. RECOMMENDATIONS
// ============================================================

Table user_book_interactions {
  id bigint [pk, increment]
  user_id bigint [not null, ref: > users.id]
  book_id bigint [not null, ref: > books.id]
  interaction_type enum('view','wishlist','cart','purchase','review') [not null]
  interaction_count int [not null, default: 1]
  last_interaction_at datetime [not null, default: `now()`]
  created_at datetime [not null, default: `now()`]
  
  indexes {
    (user_id, book_id, interaction_type) [unique]
  }
}

// ============================================================
// TABLE GROUPS
// ============================================================

TableGroup user_management {
  customer_tiers
  users
  admins
  otp_codes
}

TableGroup product_catalog {
  categories
  authors
  publishers
  books
  book_authors
  book_variants
  book_images
  price_history
}

TableGroup inventory_tables {
  inventory
  inventory_history
}

TableGroup cart_wishlist {
  carts
  wishlists
}

TableGroup promotions_tables {
  flash_sales
  flash_sale_items
  vouchers
  voucher_usage
  promotions
  promotion_books
}

TableGroup orders_tables {
  orders
  order_items
  order_status_history
  refunds
  payments
}

TableGroup rewards_tables {
  reward_points
  loyalty_transactions
}

TableGroup shipping_tables {
  shipping_carriers
  shipping_rates
}

TableGroup reviews_tables {
  reviews
  review_images
}
